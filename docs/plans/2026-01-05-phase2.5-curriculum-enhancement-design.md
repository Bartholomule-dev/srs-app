# Phase 2.5: Curriculum Enhancement Design

> **Status:** Approved
> **Created:** 2026-01-05
> **Author:** Claude + Brett (brainstorming session)

---

## Overview & Goals

**Goal:** Enhance the exercise taxonomy, improve session variety, and expand curriculum coverage to create a more pedagogically robust learning experience.

**Scope:** This design builds on the completed Phase 2 infrastructure (concept-based SRS, 171 exercises, 10 concepts). It does NOT change the core SRS algorithm or mastery criteria.

### What We're Adding

| Category | Enhancement |
|----------|-------------|
| **Quality** | New `objective` field (required) for clear learning targets |
| **Variety** | Anti-repeat pattern logic in session selection |
| **Integrated** | New `targets[]` field for multi-subconcept credit |
| **Coverage** | New subconcepts + exercises for iteration builtins, mutability, truthiness, and depth in existing areas |

### What We're NOT Changing

- SM-2 algorithm (current implementation is sound)
- Mastery criteria (80% subconcepts in review, interval >= 1 day)
- Exercise types (staying with `write` and `fill-in` for now)
- Core session flow (`useConceptSession` hook)

### Success Criteria

1. Every exercise has a clear `objective` statement
2. Sessions never show same `pattern` twice consecutively
3. Integrated exercises credit all `targets` subconcepts
4. Curriculum covers all identified "syntax cliffs"
5. All changes backward-compatible with existing data

---

## Schema Changes

### `objective` (required)

A single sentence describing the learning target. Used for feedback and pedagogical clarity.

```yaml
# Before
- slug: enumerate-loop
  prompt: Loop over items with both index and value using enumerate

# After
- slug: enumerate-loop
  objective: "Use enumerate() to iterate with both index and value"
  prompt: Loop over items with both index and value using enumerate
```

**Validation:** Required string, 10-150 characters, must start with a verb.

**Database:** Add `objective TEXT NOT NULL` to exercises table.

**JSON Schema addition:**
```json
"objective": {
  "type": "string",
  "minLength": 10,
  "maxLength": 150,
  "description": "Learning target for this exercise (start with verb)"
}
```

### `targets` (conditional)

List of subconcepts tested by an integrated exercise. Required when `level: integrated`, optional otherwise.

```yaml
- slug: list-comp-with-filter
  level: integrated
  subconcept: list-comp        # Primary subconcept (first target)
  targets: ["list-comp", "for", "conditionals", "filtering"]
```

**SRS behavior:**
- On success (quality >= 3): Credit ALL subconcepts in `targets`
- On failure (quality < 3): Only penalize primary subconcept (first in array)

**Validation:** Required array when `level: integrated`. First element must match `subconcept` field.

**Database:** Add `targets TEXT[]` to exercises table.

**JSON Schema addition:**
```json
"targets": {
  "type": "array",
  "items": { "type": "string" },
  "description": "Subconcepts tested (required for integrated level)"
}
```

---

## Selection Algorithm Changes

### Anti-Repeat Pattern Logic

**Problem:** Sessions can show multiple exercises with the same `pattern` consecutively (e.g., iteration, iteration, iteration), creating monotony.

**Solution:** Track last pattern in session state and penalize candidates with matching pattern.

**Location:** `src/lib/hooks/useConceptSession.ts`

**New session state:**
```typescript
interface SessionState {
  // ... existing fields
  lastPattern: ExercisePattern | null;
  lastExerciseSlug: string | null;
}
```

**Selection modification:**

```typescript
function selectNextCard(
  dueSubconcepts: SubconceptProgress[],
  exercises: Exercise[],
  attempts: ExerciseAttempt[],
  sessionState: SessionState
): SessionCard | null {

  // Get candidates from each due subconcept
  const candidates = dueSubconcepts.map(sp => ({
    subconcept: sp,
    exercise: selectExercise(sp, exercises, attempts)
  })).filter(c => c.exercise !== null);

  // Apply anti-repeat penalty
  const scored = candidates.map(c => ({
    ...c,
    score: c.exercise.pattern === sessionState.lastPattern ? -1 : 0
  }));

  // Sort by score (higher first), then by due-ness
  scored.sort((a, b) => b.score - a.score);

  return scored[0] ?? null;
}
```

**Fallback:** If ALL candidates have the same pattern as last (rare), allow it rather than blocking.

---

## Multi-Subconcept SRS Credit

### Integrated Exercise Behavior

**Problem:** Integrated exercises test multiple subconcepts but only credit one, under-representing mastery.

**Solution:** Use `targets[]` field to credit all tested subconcepts on success.

**Location:** `src/lib/hooks/useConceptSRS.ts` -> `recordSubconceptResult()`

**Modified flow:**

```typescript
async function recordSubconceptResult(
  exercise: Exercise,
  quality: Quality,
  wasCorrect: boolean
) {
  const targetsToCredit = exercise.targets ?? [exercise.subconcept];

  if (quality >= 3) {
    // SUCCESS: Credit all targets
    for (const target of targetsToCredit) {
      await updateSubconceptProgress(target, quality);
    }
  } else {
    // FAILURE: Only penalize primary subconcept
    const primary = targetsToCredit[0];
    await updateSubconceptProgress(primary, quality);
  }

  // Always record exercise attempt
  await recordExerciseAttempt(exercise.slug, wasCorrect);
}
```

### Rationale for Asymmetric Credit/Penalty

- **Success credits all:** If you solve an integrated problem, you demonstrated competence in all component skills
- **Failure penalizes one:** Failure could be due to any ONE skill gap. Penalizing all would be harsh and inaccurate. The primary subconcept (what the exercise is "about") takes the penalty.

### Edge Case: New Subconcepts

If a `targets` entry has no existing `subconcept_progress` row, create one with initial state before applying the review.

---

## Curriculum Expansion

### New Subconcepts

Updates to `src/lib/curriculum/python.json`:

#### Control Flow (add to existing)

```json
"subconcepts": ["conditionals", "for", "while", "iteration", "zip", "reversed", "sorted", "any-all"]
```

New subconcepts: `zip`, `reversed`, `sorted`, `any-all`

#### Collections (add to existing)

```json
"subconcepts": ["lists", "tuples", "dicts", "sets", "unpacking", "mutability"]
```

New subconcept: `mutability` (aliasing, default mutable args, shallow copies)

#### Numbers & Booleans (expand existing)

```json
"subconcepts": ["integers", "floats", "booleans", "conversion", "truthiness", "comparisons"]
```

New subconcepts: `truthiness` (falsy values, bool()), `comparisons` (is vs ==, chained, membership)

#### Functions (expand existing)

```json
"subconcepts": ["basics", "arguments", "defaults", "args-kwargs", "scope", "lambda", "typehints"]
```

New subconcepts: `defaults`, `args-kwargs` (split from `arguments` for depth)

#### Modules & Files (expand existing)

```json
"subconcepts": ["imports", "reading", "writing", "context", "pathlib", "main-guard"]
```

New subconcepts: `pathlib`, `main-guard` (`__name__ == "__main__"`)

### Exercise Targets

| Area | New Exercises | Levels |
|------|---------------|--------|
| Iteration builtins | 16-20 | intro, practice, edge per subconcept |
| Mutability | 8-10 | practice, edge (gotcha-focused) |
| Truthiness/comparisons | 10-12 | intro, practice, edge |
| Function depth | 8-10 | practice, edge for defaults/kwargs |
| Files/modules depth | 6-8 | practice, edge |
| OOP depth | 10-15 | more practice/edge for existing |
| Comprehension edge cases | 6-8 | edge level |

**Total new exercises:** ~65-85

---

## Implementation Plan

### Phase A: Schema & Infrastructure

| Task | Files | Tests |
|------|-------|-------|
| A1. Add `objective` to JSON Schema | `exercises/schema.json` | Validation script |
| A2. Add `targets` to JSON Schema | `exercises/schema.json` | Validation script |
| A3. Database migration for new columns | `supabase/migrations/` | - |
| A4. Update TypeScript types | `src/lib/curriculum/types.ts`, `src/lib/exercise/yaml-types.ts` | Type check |
| A5. Update exercise mappers | `src/lib/supabase/mappers.ts` | Unit tests |

### Phase B: Algorithm Changes

| Task | Files | Tests |
|------|-------|-------|
| B1. Add session state tracking | `src/lib/hooks/useConceptSession.ts` | Unit tests |
| B2. Implement anti-repeat pattern | `src/lib/hooks/useConceptSession.ts` | Unit tests |
| B3. Implement multi-target credit | `src/lib/hooks/useConceptSRS.ts` | Unit tests |
| B4. Update import script | `scripts/import-exercises.ts` | Integration test |

### Phase C: Curriculum Update

| Task | Files |
|------|-------|
| C1. Update `python.json` with new subconcepts | `src/lib/curriculum/python.json` |
| C2. Add `objective` to all 171 existing exercises | `exercises/python/*.yaml` |
| C3. Add `targets` to existing integrated exercises | `exercises/python/*.yaml` |

### Phase D: Content Creation

| Task | Exercises |
|------|-----------|
| D1. Iteration builtins (zip, reversed, sorted, any-all) | 16-20 |
| D2. Mutability traps | 8-10 |
| D3. Truthiness & comparisons | 10-12 |
| D4. Function depth (defaults, args-kwargs) | 8-10 |
| D5. Files/modules depth (pathlib, main-guard) | 6-8 |
| D6. OOP & comprehension depth | 16-23 |

---

## Estimated Effort

- **Phase A:** 2-3 hours (schema + migrations)
- **Phase B:** 3-4 hours (algorithm + tests)
- **Phase C:** 4-6 hours (backfill 171 exercises)
- **Phase D:** 8-12 hours (65-85 new exercises)

**Total:** ~20-25 hours of implementation

---

## Decisions Log

| Decision | Choice | Rationale |
|----------|--------|-----------|
| `objective` field | Required on all exercises | Ensures pedagogical clarity |
| `constraints` field | Skip for now | Only useful with AST validation |
| `context` field | Skip for now | Nice-to-have at 500+ exercises |
| `common_mistakes` field | Skip for now | Revisit with fill-in expansion |
| Anti-repeat mechanism | Pattern-based, session-level | Low complexity, high impact |
| Integrated credit | Multi-subconcept on success, single on failure | Balances accuracy with fairness |
| Mastery criteria | Keep current SM-2 | Current implementation is sound |
| Coverage gaps | Address all identified areas | Comprehensive curriculum |

---

## Files Changed Summary

**New/Modified Schema:**
- `exercises/schema.json`
- `src/lib/curriculum/types.ts`
- `src/lib/exercise/yaml-types.ts`

**New Migration:**
- `supabase/migrations/YYYYMMDD_add_objective_targets.sql`

**Algorithm Changes:**
- `src/lib/hooks/useConceptSession.ts`
- `src/lib/hooks/useConceptSRS.ts`
- `src/lib/supabase/mappers.ts`
- `scripts/import-exercises.ts`

**Content:**
- `src/lib/curriculum/python.json`
- `exercises/python/*.yaml` (all files)

---

## Next Steps

1. Review and approve this design
2. Use `superpowers:executing-plans` or `superpowers:subagent-driven-development` to implement
3. Start with Phase A (schema) to establish foundation
4. Content creation (Phase D) can be parallelized with algorithm work (Phase B)
